<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Refuge Game Catalog</title>

  <style>
    :root{
      --bg:#0b0f17;
      --panel: rgba(15,23,36,0.85);
      --panel2: rgba(17,26,39,0.90);
      --stroke:rgba(255,255,255,.08);
      --text:#e9eef7;
      --muted:#a9b6cb;
      --brand:#7aa2ff;
      --chip:#1b2a43;
      --chip2:#233657;
      --shadow:0 14px 50px rgba(0,0,0,.40);
      --r:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;

      /* Cinematic background */
      background:
        linear-gradient(rgba(0,0,0,0.72), rgba(0,0,0,0.72)),
        url("https://github.com/Elerstinc/Refuge-Game-Catalog/blob/main/refuge-survivor-bg.png?raw=true") center center / cover no-repeat fixed;

      min-height:100vh;
    }

    a{color:var(--brand); text-decoration:none}

    /* Keep UI above atmosphere layers */
    header, main, .modalBack, .adminBack{
      position: relative;
      z-index: 5;
    }

    /* ========= ATMOSPHERE: FOG ========= */
    .fogLayer{
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;

  /* cooler, neutral fog */
  opacity: .22;
  filter: blur(18px);

  /* multiple soft blobs, not harsh gradients */
  background:
    radial-gradient(900px 520px at 10% 80%, rgba(220,230,255,.10), transparent 70%),
    radial-gradient(800px 480px at 70% 20%, rgba(220,230,255,.08), transparent 72%),
    radial-gradient(700px 440px at 90% 85%, rgba(220,230,255,.09), transparent 75%),
    radial-gradient(900px 520px at 30% 40%, rgba(220,230,255,.06), transparent 72%);

  animation: fogDrift 36s ease-in-out infinite alternate;
  mix-blend-mode: normal;
}

.noise{
  position: fixed;
  inset: 0;
  z-index: 2;           /* above fog+embers, below UI */
  pointer-events: none;
  opacity: .08;

  /* noise made from repeating gradients */
  background-image:
    repeating-linear-gradient(0deg, rgba(255,255,255,.06) 0 1px, transparent 1px 2px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.04) 0 1px, transparent 1px 3px);
  mix-blend-mode: overlay;
}

.fogLayer.two{
  opacity: .14;
  filter: blur(26px);
  animation-duration: 58s;
}
    @keyframes fogDrift{
      0%   { transform: translate3d(-3%, 1%, 0) scale(1.03); }
      50%  { transform: translate3d(2%, -2%, 0) scale(1.05); }
      100% { transform: translate3d(4%, 2%, 0) scale(1.07); }
    }

    /* ========= ATMOSPHERE: EMBERS ========= */
    .embers{
      position: fixed;
      inset: 0;
      z-index: 1; /* above fog, below UI */
      pointer-events: none;
      opacity: .45;
      filter: blur(.2px);
    }

    .embers::before,
    .embers::after{
      content:"";
      position:absolute;
      left:-10%;
      top:110%;
      width:120%;
      height:120%;
      background: transparent;
      transform: translateZ(0);
      animation: embersRise 12s linear infinite;
    }

    /* Ember field 1 */
    .embers::before{
      opacity:.75;
      box-shadow:
        10vw  0vh 0 0 rgba(255,120,60,.55),
        22vw -8vh 0 0 rgba(255,170,90,.45),
        35vw -2vh 0 0 rgba(255,110,70,.55),
        48vw -12vh 0 0 rgba(255,200,120,.35),
        58vw -4vh 0 0 rgba(255,120,60,.45),
        66vw -10vh 0 0 rgba(255,160,90,.35),
        74vw -1vh 0 0 rgba(255,120,60,.50),
        82vw -14vh 0 0 rgba(255,210,140,.30),
        92vw -6vh 0 0 rgba(255,120,60,.40),

        14vw -18vh 0 0 rgba(255,140,80,.40),
        28vw -26vh 0 0 rgba(255,210,140,.25),
        44vw -20vh 0 0 rgba(255,120,60,.45),
        61vw -28vh 0 0 rgba(255,160,90,.30),
        79vw -22vh 0 0 rgba(255,200,120,.25),
        95vw -30vh 0 0 rgba(255,120,60,.35);
      animation-duration: 12s;
    }

    /* Ember field 2 (slower + offset) */
    .embers::after{
      opacity:.55;
      filter: blur(.6px);
      box-shadow:
        6vw  -6vh 0 0 rgba(255,200,120,.25),
        18vw -16vh 0 0 rgba(255,120,60,.35),
        31vw -10vh 0 0 rgba(255,160,90,.25),
        46vw -22vh 0 0 rgba(255,110,70,.30),
        53vw -14vh 0 0 rgba(255,210,140,.18),
        69vw -18vh 0 0 rgba(255,140,80,.22),
        77vw -12vh 0 0 rgba(255,120,60,.28),
        88vw -24vh 0 0 rgba(255,200,120,.18),

        12vw -36vh 0 0 rgba(255,120,60,.22),
        38vw -40vh 0 0 rgba(255,160,90,.18),
        62vw -44vh 0 0 rgba(255,210,140,.12),
        84vw -48vh 0 0 rgba(255,120,60,.18);
      animation-duration: 18s;
      animation-delay: -6s;
    }

    @keyframes embersRise{
      0%   { transform: translate3d(0,0,0); }
      100% { transform: translate3d(0,-140vh,0); }
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      .fogLayer, .embers::before, .embers::after{ animation: none !important; }
      .card{ transition:none !important; }
    }

    /* ========= HEADER ========= */
    header{
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background: rgba(11,15,23,.72);
      border-bottom:1px solid var(--stroke);
      z-index: 10;
    }

    .wrap{max-width:1100px; margin:0 auto; padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between}

    .title{display:flex; gap:10px; align-items:center}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, rgba(122,162,255,.35), rgba(57,217,138,.18));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:900;
    }
    .title h1{font-size:16px; margin:0; letter-spacing:.2px}
    .title .sub{font-size:12px; color:var(--muted)}

    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    input, select, textarea{
      background: rgba(255,255,255,.03);
      color: var(--text);
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:rgba(169,182,203,.70)}

    .btn{
      cursor:pointer; user-select:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover{background: rgba(255,255,255,.06)}
    .btn.primary{border-color: rgba(122,162,255,.35); background: rgba(122,162,255,.14)}
    .btn.primary:hover{background: rgba(122,162,255,.18)}
    .btn.warn{border-color: rgba(255,107,107,.28); background: rgba(255,107,107,.10)}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .chip{
      cursor:pointer;
      background: var(--chip);
      border:1px solid var(--stroke);
      padding:7px 10px;
      border-radius: 999px;
      font-size:12px;
      color: var(--muted);
    }
    .chip.on{background: var(--chip2); color: var(--text); border-color: rgba(122,162,255,.25)}
    .meta{color:var(--muted); font-size:13px; margin:10px 0 0}

    /* ========= GRID / CARDS ========= */
    main{padding:18px 0 30px}
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: repeat( auto-fill, minmax(240px, 1fr) );
      gap:14px;
    }

    .card{
      position: relative;
      overflow: hidden;

      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      cursor:pointer;
      min-height: 160px;

      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
      backdrop-filter: blur(6px);
    }

    /* Glow layer */
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(600px 120px at 30% 10%, rgba(122,162,255,.22), transparent 60%),
        radial-gradient(500px 140px at 80% 40%, rgba(57,217,138,.14), transparent 60%);
      opacity:0;
      transition: opacity .18s ease;
      pointer-events:none;
    }

    /* Edge sheen */
    .card::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: var(--r);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
      pointer-events:none;
    }

    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(122,162,255,.35);
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
    }
    .card:hover::before{opacity:1}

    .cardTop{display:flex; gap:10px; align-items:flex-start; justify-content:space-between}
    .icon{
      width:42px; height:42px; border-radius: 16px;
      background: rgba(122,162,255,.12);
      border:1px solid rgba(122,162,255,.18);
      display:grid; place-items:center;
      font-size:20px;
      flex:0 0 auto;
    }
    .name{font-weight:800; margin:0}
    .small{font-size:12px; color: var(--muted)}
    .tagrow{display:flex; flex-wrap:wrap; gap:6px}
    .tag{
      font-size:11px; color: var(--muted);
      padding:4px 8px; border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }

    /* ========= MODAL ========= */
    .modalBack{
      position:fixed; inset:0; z-index:50;
      background: rgba(0,0,0,.58);
      display:none;
      padding:18px;
      overflow:auto;
    }
    .modalBack.show{display:block}
    .modal{
      max-width: 920px;
      margin: 0 auto;
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
    }
    .modalHead{
      padding:14px 16px;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modalHead .left{display:flex; gap:12px; align-items:center}
    .modalBody{padding:16px}
    .cols{display:grid; grid-template-columns: 1.15fr .85fr; gap:14px}
    @media(max-width: 860px){ .cols{grid-template-columns:1fr} }

    .panel{
      background: rgba(255,255,255,.03);
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding:12px;
      backdrop-filter: blur(8px);
    }
    .panel h3{
      margin:0 0 8px;
      font-size:13px;
      color: var(--muted);
      letter-spacing:.25px;
      text-transform:uppercase
    }
    .steps{margin:0; padding-left:18px}
    .steps li{margin:6px 0}

    .mediaGrid{display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px}
    .mediaGrid img{
      width:100%; height:120px; object-fit:cover;
      border-radius: 14px; border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
    }
    .iframeWrap{aspect-ratio: 16 / 9; border-radius:18px; overflow:hidden; border:1px solid var(--stroke)}
    .iframeWrap iframe{width:100%; height:100%; border:0}

    /* Rules markdown styling */
    #mRules ul{ margin:0; padding-left:18px; }
    #mRules li{ margin:6px 0; }
    #mRules strong{ color: var(--text); font-weight:800; }

    /* ========= ADMIN ========= */
    .adminBack{
      position:fixed; inset:0; z-index:60;
      background: rgba(0,0,0,.62);
      display:none;
      padding:18px;
      overflow:auto;
    }
    .adminBack.show{display:block}
    .admin{
      max-width: 980px; margin:0 auto;
      background: var(--panel2);
      border:1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow);

      max-height: calc(100vh - 36px);
      display:flex;
      flex-direction:column;

      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .adminHead{
      padding:14px 16px;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex: 0 0 auto;
    }
    .adminBody{
      padding:16px;
      overflow:auto;
      flex: 1 1 auto;
    }

    .formGrid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media(max-width: 860px){ .formGrid{grid-template-columns:1fr} }
    .full{grid-column:1/-1}
    label{display:block; font-size:12px; color:var(--muted); margin:2px 0 6px}
    textarea{min-height:90px; resize:vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    code{color:rgba(233,238,247,.9)}
  </style>
</head>

<body>
  <!-- Atmosphere layers -->
  <div class="fogLayer"></div>
  <div class="fogLayer two"></div>
  <div class="noise"></div>
  <div class="embers"></div>

  <header>
    <div class="wrap">
      <div class="row">
        <div class="title">
          <div class="logo">R</div>
          <div>
            <h1>Refuge Game Catalog</h1>
            <div class="sub">Search. Filter. Deploy fun.</div>
          </div>
        </div>

        <div class="controls">
          <input id="q" placeholder="Search games, tags, keywords‚Ä¶" size="28" />
          <select id="sort">
            <option value="az">Sort: A ‚Üí Z</option>
            <option value="za">Sort: Z ‚Üí A</option>
            <option value="energy_hi">Energy: High ‚Üí Low</option>
            <option value="energy_lo">Energy: Low ‚Üí High</option>
            <option value="category">Category</option>
          </select>
          <button class="btn primary" id="suggestBtn">Submit Suggestion</button>
          <button class="btn" id="adminBtn">Admin</button>
        </div>
      </div>

      <div class="chips" id="chips"></div>
      <div class="meta" id="meta"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid" id="grid"></div>
  </main>

  <!-- Details Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div class="left">
          <div class="icon" id="mIcon">üé≤</div>
          <div>
            <div style="display:flex; gap:10px; align-items:baseline; flex-wrap:wrap">
              <div class="name" id="mTitle">Game</div>
              <div class="small" id="mCategory"></div>
            </div>
            <div class="tagrow" id="mTags"></div>
          </div>
        </div>
        <button class="btn" id="mClose">Close</button>
      </div>

      <div class="modalBody">
        <div class="cols">
          <div style="display:flex; flex-direction:column; gap:12px">
            <div class="panel">
              <h3>Rules</h3>
              <div class="small" id="mRules"></div>
            </div>

            <div class="panel">
              <h3>How to play</h3>
              <div class="small" id="mSetup"></div>
              <ol class="steps" id="mSteps"></ol>
            </div>
          </div>

          <div style="display:flex; flex-direction:column; gap:12px">
            <div class="panel">
              <h3>Quick info</h3>
              <div class="small" id="mQuick"></div>
            </div>

            <div class="panel">
              <h3>Media</h3>
              <div class="mediaGrid" id="mPhotos"></div>
              <div style="height:10px"></div>
              <div class="iframeWrap" id="mVideoWrap" style="display:none">
                <iframe id="mVideo" allowfullscreen></iframe>
              </div>
            </div>

            <div class="panel">
              <h3>Notes</h3>
              <div class="small" id="mSafety"></div>
              <div class="small" style="margin-top:10px" id="mTips"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin -->
  <div class="adminBack" id="adminBack">
    <div class="admin">
      <div class="adminHead">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <div style="font-weight:900">Admin</div>
          <div class="small">
            Edit locally ‚Üí <b>Save</b> updates preview ‚Üí <b>Download games.json</b> ‚Üí commit to GitHub to publish.
          </div>
        </div>
        <button class="btn" id="aClose">Close</button>
      </div>

      <div class="adminBody">
        <div class="formGrid">
          <div>
            <label>Pick existing entry to edit</label>
            <select id="aPick"></select>
          </div>
          <div>
            <label>Create new entry</label>
            <button class="btn" id="aNew">New entry</button>
          </div>

          <div>
            <label>ID (locked for existing entries)</label>
            <input id="aId" placeholder="auto-generated" readonly />
          </div>
          <div>
            <label>Regenerate ID from title</label>
            <button class="btn" id="aReId">Regenerate</button>
          </div>

          <div>
            <label>Title</label>
            <input id="aTitle" placeholder="Game name" />
          </div>
          <div>
            <label>Icon (emoji or leave blank)</label>
            <input id="aIcon" placeholder="üé≤" />
          </div>

          <div>
            <label>Category</label>
            <select id="aCategory">
              <option>Physical</option>
              <option>Mental</option>
              <option>Event</option>
            </select>
          </div>
          <div>
            <label>Energy (1‚Äì5)</label>
            <input id="aEnergy" type="number" min="1" max="5" placeholder="3" />
          </div>

          <div class="full">
            <label>Tags (comma-separated)</label>
            <input id="aTags" placeholder="physical, active, teamwork" />
          </div>

          <div class="full">
            <label>Keywords (comma-separated, for search)</label>
            <input id="aKeywords" placeholder="quick, funny, indoors" />
          </div>

          <div>
            <label>Age range</label>
            <input id="aAge" placeholder="Middle School+" />
          </div>
          <div>
            <label>Group size</label>
            <input id="aSize" placeholder="6‚Äì40" />
          </div>

          <div>
            <label>Time (minutes)</label>
            <input id="aTime" placeholder="10" />
          </div>
          <div>
            <label>Materials (comma-separated)</label>
            <input id="aMaterials" placeholder="chairs, cones, ball" />
          </div>

          <div class="full">
            <label>Rules (supports bullets + **bold**)</label>
            <textarea id="aRules" placeholder="- **Goal:** ...&#10;- **Out Rule:** ...&#10;&#10;**No violence.**"></textarea>
            <div class="hint">Formatting: use <code>-</code> for bullets and <code>**bold**</code> for bold text.</div>
          </div>

          <div class="full">
            <label>Setup (short)</label>
            <textarea id="aSetup" placeholder="How to set up the game‚Ä¶"></textarea>
          </div>

          <div class="full">
            <label>How to play (one step per line)</label>
            <textarea id="aSteps" placeholder="Step 1&#10;Step 2&#10;Step 3"></textarea>
          </div>

          <div class="full">
            <label>Safety notes</label>
            <textarea id="aSafety" placeholder="Boundaries, hazards, rules‚Ä¶"></textarea>
          </div>

          <div class="full">
            <label>Leader tips / variations</label>
            <textarea id="aTips" placeholder="Variations, pacing tips‚Ä¶"></textarea>
          </div>

          <div class="full">
            <label>Photos (one file path per line)</label>
            <textarea id="aPhotos" placeholder="media/photos/game1.jpg&#10;media/photos/game2.jpg"></textarea>
          </div>

          <div class="full">
            <label>Video embed URL (optional)</label>
            <input id="aVideo" placeholder="https://www.youtube.com/embed/VIDEO_ID" />
            <div class="hint">If empty, no video appears.</div>
          </div>

          <div class="full" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <button class="btn primary" id="aSave">Save (updates preview)</button>
            <button class="btn" id="aDownload">Download games.json</button>
            <button class="btn warn" id="aDelete">Delete entry</button>
            <input class="btn" type="file" id="aImport" accept="application/json" />
          </div>

          <div class="full hint">
            This site is static. ‚ÄúPublish‚Äù happens when you commit the downloaded games.json to GitHub.
            Draft edits are stored in your browser (localStorage) until you publish.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const ADMIN_PIN = "2468";
    const ADMIN_SESSION_KEY = "refuge_admin_unlocked";
    const DRAFT_STORAGE_KEY = "refuge_games_draft_v1";

    // ‚úÖ Set this to your issue form URL (you already discovered the correct repo)
    // Example:
    // "https://github.com/Elerstinc/Refuge-Game-Catalog/issues/new?template=game_suggestion.yml"
    window.SUGGEST_URL = "https://github.com/Elerstinc/Refuge-Game-Catalog/issues/new?template=game_suggestion.yml";

    // =========================
    // HELPERS
    // =========================
    const el = (id) => document.getElementById(id);

    function slugify(str){
      return String(str || "")
        .trim().toLowerCase()
        .replace(/['"]/g,"")
        .replace(/[^a-z0-9]+/g,"-")
        .replace(/^-+|-+$/g,"")
        .slice(0,80) || "new-game";
    }

    function uniq(arr){ return [...new Set(arr)].sort((a,b)=>a.localeCompare(b)); }

    function computeTagCloud(games){
      const set = new Set();
      for(const g of games){
        (g.tags || []).forEach(t => set.add(String(t).trim().toLowerCase()));
      }
      return uniq([...set].filter(Boolean));
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    // Supports:
    // - Bullets: "- " or "* "
    // - Bold: **text**
    // - Paragraphs / blank lines
    function renderMiniMarkdown(input){
      const raw = String(input || "");
      const lines = raw.split(/\r?\n/);

      let out = "";
      let inList = false;

      function boldify(escapedText){
        return escapedText.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      }

      for(const line of lines){
        const trimmed = line.trim();
        const isBullet = trimmed.startsWith("- ") || trimmed.startsWith("* ");

        if(isBullet){
          if(!inList){ out += "<ul>"; inList = true; }
          const item = trimmed.slice(2);
          out += "<li>" + boldify(escapeHtml(item)) + "</li>";
          continue;
        }

        if(inList){ out += "</ul>"; inList = false; }

        if(trimmed === ""){
          out += "<div style='height:8px'></div>";
          continue;
        }

        out += "<p style='margin:0 0 10px'>" + boldify(escapeHtml(trimmed)) + "</p>";
      }

      if(inList) out += "</ul>";
      return out;
    }

    function matches(g, q){
      if(!q) return true;
      const s = q.toLowerCase();
      const fields = [
        g.title, g.category, (g.tags||[]).join(" "), (g.keywords||[]).join(" "), g.rules
      ].join(" ").toLowerCase();
      return fields.includes(s);
    }

    // =========================
    // APP STATE
    // =========================
    const state = {
      all: [],
      tags: [],
      activeTags: new Set(),
      activeCategory: null,
      q: "",
      sort: "az",
      selected: null,
      draft: null
    };

    function passesFilters(g){
      if(state.activeCategory && String(g.category) !== state.activeCategory) return false;
      const gtags = new Set((g.tags||[]).map(x=>String(x).toLowerCase()));
      for(const t of state.activeTags){
        if(!gtags.has(t)) return false;
      }
      return true;
    }

    function sortGames(list){
      const a = [...list];
      const byTitle = (x,y)=>String(x.title).localeCompare(String(y.title));
      switch(state.sort){
        case "az": a.sort(byTitle); break;
        case "za": a.sort((x,y)=>-byTitle(x,y)); break;
        case "energy_hi": a.sort((x,y)=>(Number(y.energy)||0)-(Number(x.energy)||0) || byTitle(x,y)); break;
        case "energy_lo": a.sort((x,y)=>(Number(x.energy)||0)-(Number(y.energy)||0) || byTitle(x,y)); break;
        case "category": a.sort((x,y)=>String(x.category).localeCompare(String(y.category)) || byTitle(x,y)); break;
        default: a.sort(byTitle);
      }
      return a;
    }

    // =========================
    // RENDER UI
    // =========================
    function renderChips(){
      const holder = el("chips");
      holder.innerHTML = "";

      const cats = ["Physical","Mental","Event"];
      cats.forEach(c=>{
        const b = document.createElement("div");
        b.className = "chip" + (state.activeCategory===c ? " on" : "");
        b.textContent = c;
        b.onclick = ()=>{
          state.activeCategory = (state.activeCategory===c ? null : c);
          render();
        };
        holder.appendChild(b);
      });

      state.tags.forEach(t=>{
        const b = document.createElement("div");
        b.className = "chip" + (state.activeTags.has(t) ? " on" : "");
        b.textContent = "#" + t;
        b.onclick = ()=>{
          if(state.activeTags.has(t)) state.activeTags.delete(t);
          else state.activeTags.add(t);
          render();
        };
        holder.appendChild(b);
      });
    }

    function card(g){
      const d = document.createElement("div");
      d.className = "card";
      d.onclick = ()=>openModal(g);

      const top = document.createElement("div");
      top.className = "cardTop";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.gap = "10px";
      left.style.alignItems = "flex-start";

      const ic = document.createElement("div");
      ic.className = "icon";
      ic.textContent = (g.icon || "üé≤");

      const text = document.createElement("div");
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = g.title || "Untitled";

      const small = document.createElement("div");
      small.className = "small";
      small.textContent = `${g.category || "Uncategorized"} ‚Ä¢ Energy ${Number(g.energy)||0}/5`;

      text.appendChild(name);
      text.appendChild(small);

      left.appendChild(ic);
      left.appendChild(text);

      const right = document.createElement("div");
      right.className = "small";
      const tm = g.timeMinutes ? `${g.timeMinutes} min` : "";
      const sz = g.groupSize ? `${g.groupSize}` : "";
      right.textContent = [tm, sz].filter(Boolean).join(" ‚Ä¢ ");

      top.appendChild(left);
      top.appendChild(right);

      const tagrow = document.createElement("div");
      tagrow.className = "tagrow";
      (g.tags||[]).slice(0,6).forEach(t=>{
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = t;
        tagrow.appendChild(s);
      });

      const hint = document.createElement("div");
      hint.className = "small";
      hint.textContent = (g.keywords||[]).slice(0,6).join(" ‚Ä¢ ");

      d.appendChild(top);
      d.appendChild(tagrow);
      d.appendChild(hint);

      return d;
    }

    function render(){
      const filtered = state.all
        .filter(g => matches(g, state.q))
        .filter(passesFilters);

      const sorted = sortGames(filtered);

      el("grid").innerHTML = "";
      sorted.forEach(g => el("grid").appendChild(card(g)));

      const chipText = [
        state.activeCategory ? `Category: ${state.activeCategory}` : null,
        state.activeTags.size ? `Tags: ${[...state.activeTags].join(", ")}` : null,
        state.q ? `Search: "${state.q}"` : null
      ].filter(Boolean).join(" ‚Ä¢ ");

      el("meta").textContent = `${sorted.length} shown / ${state.all.length} total` + (chipText ? ` ‚Äî ${chipText}` : "");
    }

    // =========================
    // MODAL
    // =========================
    function openModal(g){
      state.selected = g;
      el("mIcon").textContent = g.icon || "üé≤";
      el("mTitle").textContent = g.title || "";
      el("mCategory").textContent = g.category || "";

      const tagHolder = el("mTags");
      tagHolder.innerHTML = "";
      (g.tags||[]).forEach(t=>{
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = t;
        tagHolder.appendChild(s);
      });

      const rulesText = (g.rules && String(g.rules).trim()) ? g.rules : "(Rules not added yet)";
      el("mRules").innerHTML = renderMiniMarkdown(rulesText);

      el("mSetup").textContent = g.setup ? `Setup: ${g.setup}` : "Setup: (not added yet)";

      const steps = el("mSteps");
      steps.innerHTML = "";
      const arr = (g.howToPlay && g.howToPlay.length) ? g.howToPlay : ["(How-to steps not added yet)"];
      arr.forEach(step=>{
        const li = document.createElement("li");
        li.textContent = step;
        steps.appendChild(li);
      });

      const quick = [];
      if(g.ageRange) quick.push(`Ages: ${g.ageRange}`);
      if(g.groupSize) quick.push(`Group size: ${g.groupSize}`);
      if(g.timeMinutes) quick.push(`Time: ${g.timeMinutes} min`);
      quick.push(`Energy: ${Number(g.energy)||0}/5`);
      if(g.materials && g.materials.length) quick.push(`Materials: ${g.materials.join(", ")}`);
      el("mQuick").textContent = quick.join(" ‚Ä¢ ");

      el("mSafety").textContent = g.safetyNotes ? `Safety: ${g.safetyNotes}` : "Safety: (not added yet)";
      el("mTips").textContent = g.leaderTips ? `Tips: ${g.leaderTips}` : "Tips: (not added yet)";

      const photos = el("mPhotos");
      photos.innerHTML = "";
      (g.photos||[]).forEach(p=>{
        const img = document.createElement("img");
        img.src = p;
        img.alt = g.title;
        photos.appendChild(img);
      });

      const hasVideo = !!(g.videoEmbedUrl && String(g.videoEmbedUrl).trim());
      el("mVideoWrap").style.display = hasVideo ? "block" : "none";
      el("mVideo").src = hasVideo ? g.videoEmbedUrl : "";

      el("modalBack").classList.add("show");
    }

    function closeModal(){
      el("modalBack").classList.remove("show");
      el("mVideo").src = "";
    }

    // =========================
    // ADMIN PIN
    // =========================
    function requireAdminPin(){
      if (sessionStorage.getItem(ADMIN_SESSION_KEY) === "1") return true;

      const entered = prompt("Enter admin PIN:");
      if (entered === null) return false;

      if (String(entered).trim() === ADMIN_PIN){
        sessionStorage.setItem(ADMIN_SESSION_KEY, "1");
        return true;
      }
      alert("Incorrect PIN.");
      return false;
    }

    // =========================
    // ADMIN EDITOR
    // =========================
    function blankGame(){
      return {
        id: "new-game",
        title: "",
        icon: "üé≤",
        category: "Physical",
        tags: [],
        keywords: [],
        ageRange: "",
        groupSize: "",
        timeMinutes: "",
        energy: 3,
        materials: [],
        rules: "",
        setup: "",
        howToPlay: [],
        safetyNotes: "",
        leaderTips: "",
        photos: [],
        videoEmbedUrl: ""
      };
    }

    function refreshPick(){
      const pick = el("aPick");
      pick.innerHTML = "";
      state.draft.games
        .slice()
        .sort((a,b)=>String(a.title).localeCompare(String(b.title)))
        .forEach(g=>{
          const o = document.createElement("option");
          o.value = g.id;
          o.textContent = g.title || g.id;
          pick.appendChild(o);
        });

      pick.onchange = ()=>{
        const g = state.draft.games.find(x=>x.id===pick.value);
        if(g) loadIntoForm(g);
      };
    }

    function loadIntoForm(g){
      el("aId").value = g.id || "";
      el("aTitle").value = g.title || "";
      el("aIcon").value = g.icon || "";
      el("aCategory").value = g.category || "Physical";
      el("aEnergy").value = g.energy ?? 3;
      el("aTags").value = (g.tags||[]).join(", ");
      el("aKeywords").value = (g.keywords||[]).join(", ");
      el("aAge").value = g.ageRange || "";
      el("aSize").value = g.groupSize || "";
      el("aTime").value = g.timeMinutes || "";
      el("aMaterials").value = (g.materials||[]).join(", ");
      el("aRules").value = g.rules || "";
      el("aSetup").value = g.setup || "";
      el("aSteps").value = (g.howToPlay||[]).join("\n");
      el("aSafety").value = g.safetyNotes || "";
      el("aTips").value = g.leaderTips || "";
      el("aPhotos").value = (g.photos||[]).join("\n");
      el("aVideo").value = g.videoEmbedUrl || "";
    }

    function formToGame(){
      const lockedId = el("aId").value.trim();
      const title = el("aTitle").value.trim();
      const id = lockedId || slugify(title);

      const icon = el("aIcon").value.trim() || "üé≤";
      const category = el("aCategory").value;
      const energy = Number(el("aEnergy").value || 3);
      const tags = el("aTags").value.split(",").map(x=>x.trim().toLowerCase()).filter(Boolean);
      const keywords = el("aKeywords").value.split(",").map(x=>x.trim().toLowerCase()).filter(Boolean);
      const ageRange = el("aAge").value.trim();
      const groupSize = el("aSize").value.trim();
      const timeMinutes = el("aTime").value.trim();
      const materials = el("aMaterials").value.split(",").map(x=>x.trim()).filter(Boolean);
      const rules = el("aRules").value;
      const setup = el("aSetup").value.trim();
      const howToPlay = el("aSteps").value.split("\n").map(x=>x.trim()).filter(Boolean);
      const safetyNotes = el("aSafety").value.trim();
      const leaderTips = el("aTips").value.trim();
      const photos = el("aPhotos").value.split("\n").map(x=>x.trim()).filter(Boolean);
      const videoEmbedUrl = el("aVideo").value.trim();

      return { id, title, icon, category, tags, keywords, ageRange, groupSize, timeMinutes, energy, materials, rules, setup, howToPlay, safetyNotes, leaderTips, photos, videoEmbedUrl };
    }

    function saveEntry(){
      const g = formToGame();
      if(!g.title){
        alert("Title required.");
        return;
      }

      el("aId").value = g.id;

      const idx = state.draft.games.findIndex(x=>x.id===g.id);
      if(idx >= 0) state.draft.games[idx] = g;
      else state.draft.games.push(g);

      localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify({ games: state.draft.games }));

      // LIVE PREVIEW update
      state.all = JSON.parse(JSON.stringify(state.draft.games));
      state.tags = computeTagCloud(state.all);
      renderChips();
      render();

      refreshPick();
      el("aPick").value = g.id;

      alert("Saved. Preview updated. Download games.json to publish.");
    }

    function deleteEntry(){
      const g = formToGame();
      const idx = state.draft.games.findIndex(x=>x.id===g.id);
      if(idx < 0){ alert("Nothing to delete."); return; }
      if(!confirm(`Delete "${g.title}"?`)) return;

      state.draft.games.splice(idx, 1);
      localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify({ games: state.draft.games }));

      state.all = JSON.parse(JSON.stringify(state.draft.games));
      state.tags = computeTagCloud(state.all);
      renderChips();
      render();

      refreshPick();
      loadIntoForm(state.draft.games[0] || blankGame());
    }

    function downloadJSON(){
      const payload = JSON.stringify({ games: state.draft.games }, null, 2);
      const blob = new Blob([payload], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "games.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!data || !Array.isArray(data.games)) throw new Error("Invalid format");
          state.draft = data;
          localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify({ games: state.draft.games }));

          state.all = JSON.parse(JSON.stringify(state.draft.games));
          state.tags = computeTagCloud(state.all);
          renderChips();
          render();

          refreshPick();
          loadIntoForm(state.draft.games[0] || blankGame());
          alert("Imported into editor. Preview updated.");
        }catch(e){
          alert("Import failed: " + e.message);
        }
      };
      reader.readAsText(file);
    }

    function openAdmin(){
      const saved = localStorage.getItem(DRAFT_STORAGE_KEY);
      if(saved){
        try{
          const parsed = JSON.parse(saved);
          if(parsed && Array.isArray(parsed.games)) state.draft = parsed;
          else state.draft = JSON.parse(JSON.stringify({ games: state.all }));
        }catch{
          state.draft = JSON.parse(JSON.stringify({ games: state.all }));
        }
      }else{
        state.draft = JSON.parse(JSON.stringify({ games: state.all }));
      }

      refreshPick();
      loadIntoForm(state.draft.games[0] || blankGame());
      el("adminBack").classList.add("show");
    }

    function closeAdmin(){ el("adminBack").classList.remove("show"); }

    // =========================
    // WIRING
    // =========================
    el("q").addEventListener("input", (e)=>{ state.q = e.target.value.trim(); render(); });
    el("sort").addEventListener("change", (e)=>{ state.sort = e.target.value; render(); });

    el("mClose").onclick = closeModal;
    el("modalBack").onclick = (e)=>{ if(e.target.id === "modalBack") closeModal(); };

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") { closeModal(); closeAdmin(); }
    });

    el("adminBtn").onclick = () => {
      if(!requireAdminPin()) return;
      openAdmin();
    };

    el("aClose").onclick = closeAdmin;
    el("aSave").onclick = saveEntry;
    el("aDelete").onclick = deleteEntry;
    el("aDownload").onclick = downloadJSON;
    el("aImport").addEventListener("change", (e)=>{ if(e.target.files[0]) importJSON(e.target.files[0]); });

    el("aNew").onclick = ()=>{
      loadIntoForm(blankGame());
      el("aId").value = "";
    };

    el("aReId").onclick = ()=>{
      const title = el("aTitle").value.trim();
      if(!title){ alert("Enter a title first."); return; }
      el("aId").value = slugify(title);
      alert("ID regenerated. Saving now will use this ID.");
    };

    el("suggestBtn").onclick = ()=>{
      const url = window.SUGGEST_URL || "";
      if(!url){
        alert("Set SUGGEST_URL in the script (near the top).");
        return;
      }
      window.open(url, "_blank", "noopener,noreferrer");
    };

    // =========================
    // INIT
    // =========================
    async function init(){
      const res = await fetch("games.json", {cache:"no-store"});
      const data = await res.json();

      state.all = (data.games || []).map(g=>{
        return {
          id: g.id || slugify(g.title||""),
          title: g.title || "",
          icon: g.icon || "üé≤",
          category: g.category || "Physical",
          tags: (g.tags||[]).map(x=>String(x).toLowerCase()),
          keywords: (g.keywords||[]).map(x=>String(x).toLowerCase()),
          ageRange: g.ageRange || "",
          groupSize: g.groupSize || "",
          timeMinutes: g.timeMinutes || "",
          energy: (g.energy ?? 3),
          materials: g.materials || [],
          rules: g.rules || "",
          setup: g.setup || "",
          howToPlay: g.howToPlay || [],
          safetyNotes: g.safetyNotes || "",
          leaderTips: g.leaderTips || "",
          photos: g.photos || [],
          videoEmbedUrl: g.videoEmbedUrl || ""
        };
      });

      state.tags = computeTagCloud(state.all);
      renderChips();
      render();
    }

    init();
  </script>
</body>
</html>
